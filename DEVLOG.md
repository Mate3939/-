# 개발 일지

## 2026-01-18: 프로젝트 시작 및 v2 재설계

### 목표
자율주행 대회용 스테레오 카메라 거리 측정 시스템 구축

### 하드웨어 구성
- **카메라**: HD Webcam Pro x2
  - 카메라 0 (좌), 카메라 2 (우)
  - 초기에 1, 2번으로 착각 → 좌우 반전 이슈 발생
  - 최종적으로 0, 2번 확정
- **해상도**: 640x480 → 1280x720 (HD)로 변경
  - 이유: 더 정밀한 측정 필요
- **Baseline**: ~167mm (실측 필요)

### 주요 이슈 및 해결

#### 1. 카메라 인덱스 혼동
**문제**:
- 처음에 카메라 2, 3으로 인식
- 이후 1, 2로 변경
- 좌우 반전 발생
- 사용자 요청으로 롤백 시도했으나 착오 발생

**해결**:
- `camera_test.py`로 정확히 확인
- **최종: 카메라 0 (LEFT), 카메라 2 (RIGHT)**

#### 2. 해상도 문제
**문제**:
- HD (1280x720)로 설정했더니 화면이 모니터에 다 안 보임
- 사용자가 "화면이 한번에 안보여" 피드백

**해결**:
- 640x480으로 일시 변경
- 이후 v2에서 HD 재적용 + 화면 크기 조정 (50% 스케일)

#### 3. FOV 확대 문제 (핵심 이슈)
**문제**:
- 거리 측정 시 화면이 "디지털 줌"처럼 확대됨
- 2m 거리의 테이프가 화면 꽉 참
- FOV가 좌측 우상단에 고정됨
- 캘리브레이션하지 않은 영역만 보임

**원인**:
- `cv2.stereoRectify`의 `alpha=0` 설정
- alpha=0: 유효 픽셀만 유지 → 이미지 크롭 → FOV 좁아짐

**해결**:
- **alpha=1**로 변경 (전체 FOV 유지)
- 검은 영역 생길 수 있지만 FOV 정상화

#### 4. 상하 반전
**문제**:
- 카메라가 거꾸로 설치되어 천장이 보임
- calibration 때는 정상, test_distance 때만 반전

**해결**:
- 처음에 flip 코드 추가했으나 제거
- 이유: calibration도 반전 상태로 했기 때문
- 카메라 자체를 뒤집어 놓은 상태로 캘리브레이션 진행

#### 5. 거리 측정 오차 (미해결)
**문제**:
- 실측: 90mm
- 측정: 162.58mm
- **오차: 80%**

**원인 분석**:
- Focal length = 69.28 (너무 낮음, 정상: 500~700)
- 기존 캘리브레이션이 alpha=0으로 되어 있었음

**해결 계획**:
- alpha=1로 재캘리브레이션
- 10~20장 고품질 사진만 사용 (100장+ 오히려 부정확)
- Focal length 500~700 범위 확인

#### 6. 체스보드 빛 반사 문제
**문제**:
- 태블릿 화면에 체스보드 띄우기 → 빛 반사 심함
- 캘리브레이션 품질 저하

**해결**:
- 체스보드를 종이에 인쇄
- `pattern.py`로 인쇄용 PNG 생성

#### 7. 시각화: 컬러맵 → 흑백
**사용자 요청**: "색으로 뜨게 말고 흑백으로 가능하냐 명암비로?"

**변경**:
- 기존: `cv2.applyColorMap(disp_visual, cv2.COLORMAP_JET)` (빨강/파랑)
- 변경: 흑백 명암 (밝음=가까움, 어두움=멀리)
- 더 직관적

### 캘리브레이션 파라미터

#### 체스보드
- **내부 코너**: 7x5 (8x6 사각형)
- **사각형 크기**: 23.5mm
  - 초기: 25mm → 28mm → **23.5mm** (최종)
  - 여러 명이 자로 재서 확인함

#### 스테레오 설정
- **alpha**: 0 → **1** (FOV 문제 해결)
- **해상도**: 640x480 → **1280x720** (HD)
- **권장 캡처 수**: 10~20장
  - 100장+ 시도했으나 노트북 뻗음
  - 오히려 적은 고품질 데이터가 더 정확

### 기술적 발견

#### 거리 분해능
**이론값** (Baseline=167mm, f=600):
- 500mm: ~0.26mm
- 1000mm: ~1.0mm
- 2000mm: ~4.2mm
- **5000mm: ~26mm**

**실제 정확도**:
- 0.5~2m: 5~10mm (권장 범위)
- 5m: 센티미터 단위도 어려움
- **현재 Baseline으로는 5m 측정 부적합**

**5m 측정 개선 방법**:
- Baseline을 500~1000mm로 늘리기
- 하지만 대회에서는 1~3m 범위면 충분할 듯

#### 캘리브레이션 품질 vs 데이터 개수
**발견**: 많은 데이터가 꼭 좋은 건 아님
- 200장: 노트북 뻗음
- 100장: 가능하지만 문제 많음
- **10~20장 고품질**: 가장 유의미

**이유**:
- 체스보드 코너 잘못 찾으면 outlier
- 메모리 과부하
- 품질 > 개수

### 파일 구조 개선

#### v1 (실패작)
```
calibration.py, test_distance.py, depth_*.py, camera_test.py, ...
→ 파일 너무 많고 복잡
```

#### v2 (현재)
```
calib.py       # 캘리브레이션
measure.py     # 거리 측정
pattern.py     # 체스보드 생성
```

**개선점**:
- 역할별 파일 1개씩
- 명확한 네이밍
- 기존 파일은 `실패작_2D체스판/` 폴더로 이동

### 향후 통합 계획

#### YOLO 차선 인식
- 주최측 데이터셋 제공 (품질 좋음)
- 단, 바닐라 상태 (파일명에 좌표값 없음)
- 전처리 필요

#### 신호등 인식
- 기존 알고리즘 있음 (원 인식 방식)
- 거리는 크기 기반 추정 (5m+ 스테레오 부정확)

#### 아두이노 메가 통신
```python
# 거리 → 조향각 계산
left_dist, right_dist = measure_lane_distance()
steer_angle = calculate_steering(left_dist, right_dist)

# 시리얼 전송
arduino.write(f"STEER:{steer_angle}\n")
```

**프로토콜**:
- `STEER:45\n` - 조향 45도
- `SPEED:50\n` - 속도 50%
- `STOP\n` - 정지 (신호등 빨강)

### 개발 환경

#### 개발 PC
- GPU: RTX 4070Ti Super (16GB VRAM)
- 예상 성능: 50~60fps (YOLO + 스테레오)

#### 대회 노트북
- GPU: RTX 4050 Laptop (6GB VRAM)
- 예상 성능: 20~25fps
- **호환**: 같은 Ada Lovelace 아키텍처 → 100% 호환

#### 환경 설정
- Python 3.9
- OpenCV 4.x
- NumPy
- (향후) PyTorch + YOLOv8

### Git 관리
- GitHub Private Repository
- 이유: 파일 전송 시 누락 방지 ("ㅈ같은게 나중에 가니까 파일 안넘어오는게 있더라고")
- 버전 관리로 실험 추적

### 다음 단계

1. **메인 컴퓨터로 이동**
   - 4070Ti Super 환경에서 개발
   - 카메라 연결 및 인덱스 재확인 (0, 2 맞는지)

2. **재캘리브레이션**
   - 체스보드 인쇄 (23.5mm 확인)
   - 10~20장 고품질 촬영
   - Focal length 확인 (500~700)

3. **거리 측정 검증**
   - 1~3m 거리에서 정확도 테스트
   - 오차 5~10mm 이내 목표

4. **YOLO 통합**
   - 차선 인식 + 거리 측정
   - 실시간 처리 확인

5. **아두이노 연동**
   - pyserial 통신
   - 조향 제어 로직

## 교훈

### 기술적
1. **alpha 파라미터의 중요성**: 스테레오 rectification에서 FOV에 큰 영향
2. **데이터 품질 > 개수**: 캘리브레이션은 고품질 10~20장이 최적
3. **Baseline의 한계**: 167mm로는 5m 측정 부정확, 용도에 맞게 설계 필요

### 프로세스
1. **파일 관리**: 단순하게, 역할별 1개씩
2. **Git 필수**: 파일 누락 방지
3. **명확한 소통**: 카메라 번호, 해상도 등 정확히 확인

### 사용자 피드백
- "시발련아" - 실수에 대한 강한 피드백, 주의 깊게 듣기
- "알잘딱" - 핵심만 간결하게
- 기술 용어보다 실제 문제 해결 중심

## 참고 자료

### 스테레오 비전 이론
- Disparity: `d = (f × B) / Z`
- Depth resolution: `ΔZ = (Z² × Δd) / (f × B)`
- Baseline이 클수록 먼 거리 측정 유리

### OpenCV 함수
- `cv2.stereoCalibrate()`: 스테레오 캘리브레이션
- `cv2.stereoRectify()`: alpha 파라미터 중요
- `cv2.StereoSGBM_create()`: Semi-Global Block Matching

### 최적화
- SGBM 파라미터: NumDisp, BlockSize 조정
- 히스토그램 균등화로 조명 보정
- WLS 필터 (향후 고려)

---

## 2026-01-20: 데스크톱 환경 이전 및 캘리브레이션 검증

### 환경 이전
- 랩탑(RTX 4050) → 데스크톱(RTX 4070Ti Super) 환경 전환
- Git으로 코드 동기화 완료
- 캘리브레이션 파일 경로 변경: `C:\Users\mts20\Desktop\자율주행\calibration_data.npz`

### 카메라 인덱스 재설정

#### 문제
- 기존: LEFT_CAM=0, RIGHT_CAM=2
- 데스크톱에서 카메라 0이 폰 카메라(Windows Phone Link)로 인식됨
- HD Pro Webcam C920 중 하나가 "Unknown" 상태

#### 해결
- **USB 허브 사용**으로 해결
- 최종 설정: **LEFT_CAM=2, RIGHT_CAM=1**
- 카메라 물리적 위치: 왼쪽=카메라2, 오른쪽=카메라1

### 캘리브레이션 검증 ✅

#### 테스트 환경
- 빈 방에서 거리 측정
- 자로 실측값 확인

#### 결과
- **1~3m 거리: ±2cm 오차** ✅
  - 자율주행 대회에 충분한 정확도
  - 실측값과 거의 일치
- **근거리 (50cm 이하): 측정 부정확** ⚠️
  - Baseline(167mm) 대비 너무 가까움
  - FOV 겹침 부족
  - 초음파/적외선 센서 병행 권장

#### 의의
- **스테레오 카메라 시스템 검증 완료**
- 대회 목표 거리(1~3m)에서 신뢰할 수 있는 정확도 확보

### YOLO 통합 시도 및 롤백

#### 시도 내용
1. `measure_hand.py` 생성
   - YOLOv8 객체 감지
   - MediaPipe 손 인식 시도
2. MediaPipe API 호환성 문제 (`'solutions'` attribute 없음)
3. YOLO 단독 실행으로 변경

#### 문제
- **YOLO가 객체 인식 자체를 못함**
- 바운딩 박스가 전혀 표시되지 않음
- 카메라 로드 문제도 발생

#### 조치
- **Git 롤백** (`measure.py` 복원)
- 기본 거리 측정 기능으로 복귀
- YOLO 통합은 추후 재시도

### 스테레오 비전 레퍼런스 카메라 문제

#### 초기 혼란
- 사용자 요구: "오른쪽 카메라를 주 시야로"
- "교점이 되는 지점은 오른쪽으로 해서 만들고 겹쳐지게 만들어야 한다"
- 왼쪽/오른쪽 카메라가 depth 카메라에 겹쳐져 보이는 문제

#### 조사 결과 (웹 검색)
**OpenCV 표준 규칙**:
- `stereo.compute(left, right)` 순서 고정
- **왼쪽 카메라가 항상 레퍼런스**
- 3D 좌표는 왼쪽 카메라 위치 기준
- Q matrix도 왼쪽 기준으로 생성됨

**참고 자료**:
- LearnOpenCV: Making a Low-Cost Stereo Camera
- OpenCV 공식 문서: Depth Map from Stereo Images
- ROS/OpenCV 스테레오 비전 표준

#### 해결책
- **왼쪽 카메라를 레퍼런스로 확정**
- 사용자 동의: "주 시야는 내가 정한거라 상관 없음. 왼쪽이 레퍼런스 자료면 왼쪽으로 가자"
- 표준 방식 준수로 안정성 확보

### measure.py 최종 수정

#### 변경 사항
```python
# 카메라 설정
LEFT_CAM = 2  # 레퍼런스 (OpenCV 표준)
RIGHT_CAM = 1  # 보조 (거리 계산용)

# Disparity 계산 (왼쪽 카메라 기준)
disparity = stereo.compute(gray_left, gray_right)

# Q matrix 원본 사용 (왼쪽 기준 캘리브레이션)
points_3d = cv2.reprojectImageTo3D(disparity, Q)

# Display
cv2.imshow("Depth Map", disp_display)
cv2.imshow("Original (Left Camera - Reference)", rect_left)
```

#### 화면 구성
1. **Depth Map**: 흑백 명암비 (밝음=가까움, 어두움=멀리)
   - 왼쪽 카메라 관점의 깊이 정보
   - 마우스 클릭으로 거리 측정
2. **Original (Left Camera - Reference)**: 왼쪽 카메라 원본 컬러 영상
   - 레퍼런스 카메라 시야

### 기술적 발견

#### OpenCV 스테레오 비전 표준
1. **왼쪽 카메라 = 레퍼런스**
   - 모든 3D 좌표는 왼쪽 카메라 기준
   - `stereoCalibrate()`도 왼쪽 기준 Q matrix 생성
2. **오른쪽 카메라를 레퍼런스로 쓰려면**:
   - Q matrix 재계산 필요 (`Q[3,2] *= -1`)
   - Disparity 계산 순서 변경 (`compute(right, left)`)
   - 복잡하고 비표준적
3. **권장**: 표준 방식(왼쪽 레퍼런스) 유지

#### Baseline 위치 확인
- 현재 설정: 왼쪽(카메라2) - 오른쪽(카메라1)
- Baseline: ~167mm
- OpenCV 표준과 일치하는 배치

### 근거리 오차 대응 결정

#### 문제
- 50cm 이하 거리에서 측정 오차가 큼
- Baseline(167mm) 한계

#### 해결 방안 검토
1. NumDisparities 증가 (256)
2. MinDisparity 음수 설정
3. WLS Filter 추가
4. Baseline 물리적으로 줄이기 (50~100mm)
5. 초음파 센서 병행
6. Wide Angle 렌즈 교체

#### 최종 결정 ✅
**근거리(<50cm) 측정은 불필요**
- 이유: 차량 길이 고려 시 50cm는 충돌 직전 거리
- 자율주행에서 중요한 거리: **1~3m**
- 현재 시스템 정확도(±2cm)로 충분
- **추가 수정 없이 진행**

### 다음 단계

1. **measure_hand.py, measure_yolo.py 수정**
   - 왼쪽 카메라 레퍼런스로 통일
   - 카메라 인덱스 업데이트 (2, 1)

2. **YOLO 통합 재시도**
   - 객체 인식 안되는 문제 디버깅
   - 모델 로드 확인
   - Confidence threshold 조정

3. **차선 인식**
   - 주최측 데이터셋 전처리
   - YOLOv8 Fine-tuning

4. **아두이노 연동**
   - pyserial 통신 구현
   - 거리 → 조향각 변환 로직

### 교훈

#### 표준 준수의 중요성
- OpenCV는 왼쪽 카메라 레퍼런스가 표준
- 표준을 따르면 안정적이고 예측 가능
- 비표준 방식은 복잡도만 증가

#### 웹 검색 활용
- 로지텍 C920 스테레오 비전 레퍼런스 많음
- OpenCV 공식 문서 + 커뮤니티 자료 조합
- 표준 규칙 확인 필수

#### 롤백의 중요성
- YOLO 통합 실패 시 즉시 롤백
- Git 버전 관리로 안전하게 복원
- 기본 기능 먼저 안정화, 기능 추가는 나중에
