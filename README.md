# 스테레오 카메라 거리 측정 시스템

자율주행 대회용 스테레오 비전 기반 거리 측정 및 차선 인식 시스템

## 📁 프로젝트 구조

```
스테레오 카메라/
├── calib.py              # 스테레오 카메라 캘리브레이션
├── measure.py            # 거리 측정 (흑백 명암비)
├── pattern.py            # 체스보드 패턴 생성
├── chessboard_print.png  # 체스보드 이미지 (인쇄용)
├── calib_data.npz        # 캘리브레이션 데이터 (생성 후)
├── DEVLOG.md             # 개발 일지
└── 실패작_2D체스판/       # 이전 버전 (참고용)
```

## 🎯 시스템 사양

### 하드웨어
- **카메라**: HD Webcam Pro x2 (USB)
  - 좌측: 카메라 0
  - 우측: 카메라 2
  - 해상도: 1280x720 (HD)
  - Baseline: ~167mm

- **개발 PC**: RTX 4070Ti Super
- **대회 노트북**: RTX 4050 Laptop

### 소프트웨어
- Python 3.9
- OpenCV 4.x
- NumPy

## 🚀 사용 방법

### 1. 체스보드 인쇄
```bash
python pattern.py
```
- `chessboard_print.png` 생성됨
- A4 용지에 인쇄
- 자로 한 칸 크기 측정 (현재: 23.5mm)

### 2. 캘리브레이션
```bash
python calib.py
```
- 's' 키: 사진 촬영 (10~20장 권장)
- 'c' 키: 캘리브레이션 시작
- 'q' 키: 종료

**주의**: 다양한 각도/거리/위치에서 촬영

### 3. 거리 측정
```bash
python measure.py
```
- 마우스 클릭: 거리 측정
- 's' 키: 측정값 기록
- 'q' 키: 종료

**화면**:
- Depth Map (흑백): 밝음=가까움, 어두움=멀리
- Original: 좌/우 카메라 원본

## 📊 캘리브레이션 파라미터

### 체스보드
- 내부 코너: 7x5
- 사각형 크기: 23.5mm (측정 확인됨)

### 스테레오 설정
- alpha=1 (전체 FOV 유지)
- HD 해상도 (1280x720)
- SGBM 매칭 알고리즘

## 🎓 측정 범위

| 거리 | 이론 분해능 | 실제 정확도 |
|------|------------|------------|
| 0.5~2m | ~1mm | ±2cm (검증됨) |
| 2~3m | ~4mm | ±2cm (검증됨) |
| 3~5m | ~10mm | 3~5cm |
| 5m+ | ~26mm | 부정확 |

**최적 측정 거리**: 0.5~3m

**검증 완료 (데스크톱, 2026-01-20)**:
- 빈 방 끝지점까지 측정 → ±2cm 오차 ✅
- **근거리 (50cm 이하)**: 측정 부정확 ⚠️
  - Baseline(167mm) 대비 너무 가까움
  - FOV 겹침 부족
- USB 허브 사용 (카메라 1, 2)
- HD 해상도 (1280x720)

**대회 시나리오**:
- 자율주행: 1~3m 거리 측정 필요 → **최적 범위** ✅
- 근거리는 초음파/적외선 센서 병행 권장

## 🔧 문제 해결

### 캘리브레이션 실패
- 체스보드가 양쪽 카메라에 선명하게 보여야 함
- 10~20장이 적당 (너무 많으면 오히려 부정확)
- Focal length가 500~700 범위인지 확인

### FOV가 이상함
- alpha=1 설정 확인
- 재캘리브레이션 필요

### 거리 측정 오차
- 텍스처 있는 물체에서 측정 (평평한 벽 X)
- NumDisp, BlockSize 슬라이더 조정
- 조명 확인

## 🚗 향후 계획

### Phase 1: 스테레오 거리 측정 (현재)
- [x] 카메라 설정
- [x] 캘리브레이션 코드
- [x] 거리 측정 기본 기능
- [ ] 정확도 검증 (1~3m 거리)

### Phase 2: YOLO 차선 인식 통합
- [ ] YOLOv8 설치
- [ ] 주최측 데이터셋 전처리
- [ ] 차선 인식 + 거리 측정 통합

### Phase 3: 신호등 인식
- [ ] 기존 알고리즘(원 인식) 통합
- [ ] 신호 상태별 제어 로직

### Phase 4: 아두이노 메가 연동
- [ ] pyserial 통신
- [ ] 조향 제어 프로토콜
- [ ] 실차 테스트

## 📝 주요 이슈

### 해결됨
- ✅ 카메라 인덱스 혼동 (0, 2 확정)
- ✅ 해상도 문제 (1280x720 HD)
- ✅ FOV 확대 문제 (alpha=0→1)
- ✅ 컬러맵 → 흑백 명암비
- ✅ 상하 반전 (카메라 설치 방향)

### 진행 중
- ⚠️ 거리 측정 정확도 (캘리브레이션 품질 개선 필요)

## 💡 참고 사항

### 카메라 옮길 때
- **같은 카메라** 사용 시: `calib_data.npz` 복사만 하면 됨
- **다른 카메라** 사용 시: 재캘리브레이션 필요
- **위치/간격/각도** 바뀌면: 재캘리브레이션 필요

### GPU 호환성
- 개발 PC (4070Ti Super) ↔ 노트북 (4050) 완벽 호환
- 같은 Ada Lovelace 아키텍처
- PyTorch .pt 파일 그대로 사용 가능

## 📞 문제 발생 시

1. `DEVLOG.md` 확인 (상세 개발 과정)
2. `실패작_2D체스판/` 폴더 참고 (이전 시도)
3. GitHub Issues 활용
